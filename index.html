<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>settings-panel</title>
    <script type="importmap">
    {
      "imports": {
        "sprae": "https://esm.sh/sprae@12",
        "sprae/store": "https://esm.sh/sprae@12/store"
      }
    }
    </script>
    <!-- <script type="importmap">
    {
      "imports": {
        "sprae": "../node_modules/sprae/sprae.js",
        "sprae/store": "../node_modules/sprae/store.js"
      }
    }
    </script> -->
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: system-ui;
        /* Derive from panel's --bg, darken by 0.1 L */
        background: oklch(from var(--bg, oklch(.96 0 0)) calc(l - 0.1) c h);
      }
    </style>
  </head>

  <body>
    <div id="panel"></div>

    <script type="module">
      import settings from './index.js'
      import base from './theme/default.js'
      import skeu from './theme/skeu.js'

      const themes = { default: base, skeu }
      const axes = {
        default: ['shade', 'accent', 'spacing', 'size', 'weight', 'roundness'],
        skeu: ['shade', 'accent', 'spacing', 'size', 'weight', 'roundness', 'contrast', 'depth', 'relief', 'bevel', 'grid'],
      }

      const paramKeys = ['shade', 'accent', 'weight', 'contrast', 'relief', 'depth', 'roundness', 'spacing', 'size', 'bevel', 'grid']
      const getParams = (s) => Object.fromEntries(paramKeys.map(k => [k, s[k]]))

      const rand = (lo, hi, step = 0) => {
        const v = lo + Math.random() * (hi - lo)
        return step ? Math.round(v / step) * step : v
      }
      const randHex = () => '#' + Array.from({ length: 3 }, () => Math.floor(Math.random() * 256).toString(16).padStart(2, '0')).join('')

      const schema = {
        foldable: false,
        theme: { type: 'select', options: ['default', 'skeu'], value: 'skeu' },

        'params.shade': '#f7f7f7',
        'params.accent': '#2967fa',
        'params.weight': { type: 'slider', value: 400, min: 100, max: 900, step: 50, marks: true, snap: true },
        'params.contrast': { type: 'slider', value: 0.25, min: 0, max: 1, step: 0.01, marks: true, curve: 2 },
        'params.bevel': { type: 'slider', value: 1, min: 0, max: 2, step: 0.1, marks: true },
        'params.relief': { type: 'slider', value: 0.1, min: 0, max: 1, step: 0.01 },
        'params.depth': { type: 'slider', value: 1, min: 0, max: 2, step: 0.1, marks: true },
        'params.roundness': { type: 'slider', value: 1, min: 0, max: 2, marks: true, step: 0.25 },
        'params.spacing': { type: 'slider', value: 1, min: 0.5, max: 2, step: 0.25, marks: true },
        'params.size': { type: 'slider', value: 1, min: 0.5, max: 2, step: 0.25, marks: true },
        'params.grid': { type: 'select', variant: 'buttons', multiple: true, options: ['dots', 'lines', 'crosses'], value: [] },

        code: { type: 'textarea', variant: 'code', label: '', value: '', readonly: true },
        actions: { type: 'button', label: '', variant: 'group', buttons: {
          'Random': { variant: 'secondary', onclick: () => randomize() },
          'Copy': () => navigator.clipboard.writeText(state?.code)
        }}
      }

      let state
      let curTheme, curFoldable

      function create() {
        const foldable = state?.foldable ?? false
        state?.[Symbol.dispose]()
        state = settings(schema, {
          title: 'Settings',
          collapsed: foldable ? false : undefined,
          container: '#panel',
          theme: (s) => themes[s.theme](getParams(s)),
          persist: 'settings-panel',
          onchange(s) {
            s.code = JSON.stringify(getParams(s), null, 2)
            if (s.theme !== curTheme || s.foldable !== curFoldable) {
              curTheme = s.theme
              curFoldable = s.foldable
              requestAnimationFrame(create)
              return
            }
            syncBg()
          }
        })
        curTheme = state.theme
        curFoldable = state.foldable
        state.code = JSON.stringify(getParams(state), null, 2)
        syncBg()
        syncAxes(curTheme)
      }

      create()

      function randomize() {
        if (!state) return
        state.shade = randHex()
        state.accent = randHex()
        state.weight = rand(100, 900, 100)
        state.contrast = rand(0, 1, 0.01)
        state.bevel = rand(0, 2, 0.1)
        state.relief = rand(0, 1, 0.01)
        state.depth = rand(0, 2, 0.01)
        state.roundness = rand(0, 2, 0.25)
        state.spacing = rand(0.5, 2, 0.25)
        state.size = rand(0.5, 2, 0.25)
      }

      function syncBg() {
        const el = document.querySelector('.s-panel')
        if (!el) return
        const bg = getComputedStyle(el).getPropertyValue('--bg')
        if (bg) document.documentElement.style.setProperty('--bg', bg)
      }

      function syncAxes(theme) {
        const supported = axes[theme]
        const panel = document.querySelector('.s-panel')
        if (!panel) return
        for (const el of panel.querySelectorAll('[data-key]')) {
          const key = el.dataset.key
          if (!paramKeys.includes(key)) continue
          const input = el.querySelector('.s-input')
          if (input) input.disabled = supported ? !supported.includes(key) : false
        }
      }
    </script>
  </body>

</html>
